commonfields:
  id: OPSWAT-Metadefender
  version: -1
name: OPSWAT-Metadefender
display: OPSWAT-Metadefender
category: Data Enrichment
image: data:image/png;base64,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
description: At the heart of the solution, the Metadefender multi-scanning engine
  uses 30+ anti-malware engines to scan files for threats, significantly increasing
  malware detection.
configuration:
- display: Server URL (e.g. http://localhost:8008/metascan_rest/)
  name: url
  defaultvalue: http://localhost:8008/metascan_rest/
  type: 0
  required: true
- display: API Key
  name: api
  defaultvalue: ""
  type: 4
  required: false
- display: Do not validate server certificate (insecure)
  name: insecure
  defaultvalue: "true"
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: "false"
  type: 8
  required: false
- display: 'The low threshold '
  name: lowPercnt
  defaultvalue: "34"
  type: 0
  required: true
- display: 'The high threshold '
  name: highPercnt
  defaultvalue: "66"
  type: 0
  required: true
script:
  script: |
    var sendRequest = function(url,param, fileId) {
        var requestUrl = params.url + url + param;
        var res;

        if (fileId) {
            var fileName = dq(invContext, 'File(val.EntryID == \'' + fileId + '\').Name');
            res = httpMultipart(
                requestUrl,
                fileId,
                {
                    Method: 'POST',
                    Headers: {
                        Accept: ['application/json'],
                        filename: fileName
                    }
                },
                {},
                params.insecure,
                params.proxy,
                undefined,
                'file',
                fileName);
        } else {
            res = http(
                requestUrl,
                {
                    Method: 'GET',
                    Headers: {
                        Accept: ['application/json']
                    }
                }
                );
        }


        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }

        return res;
    };


    var searchHash = function() {
        var res;
        try {
            res = JSON.parse(sendRequest('/hash/', args.hash).Body);
        } catch (err) {
            throw 'Error in JSON parsing\n';
        }
        var md = '# OPSWAT-Metadefender\n';
        var ec = {};
        var dbotScore = 0;

        md += '### Results for Hash ' + args.hash + '\n';

        if (res.file_info) {
            md += 'File name: ' + res.file_info.display_name + '\n';
            md += 'File description: ' + res.file_info.file_type_description + '\n';
            md += 'Scan result: ' + res.scan_results.scan_all_result_a + '\n';
            md += 'Detected AV: ' + res.scan_results.total_detected_avs + '/' + res.scan_results.total_avs + '\n';

            md += 'AV Name|Def Time|Threat Name Found\n';
            md += '---|---|---\n';

            var avRes = res.scan_results.scan_details;

            Object.keys(avRes).forEach(function(key) {
              md += key + '|';
              md += avRes[key].def_time + '|';
              md += avRes[key].threat_found + '\n';
            });

            var percntBad = (res.scan_results.total_detected_avs / res.scan_results.total_avs) * 100;

            if (percntBad >= parseInt(params.highPercnt)) {
                dbotScore = 3;
                addMalicious(ec, outputPaths.file,{
                    Hash: args.hash,
                    Malicious: {Vendor: 'OPSWAT', Description: 'Result from OPSWAT-Metadefender'}
                });
            } else if (percntBad >= parseInt(params.lowPercnt)) {
                dbotScore = 2;
            } else {
                dbotScore = 1;
            }
            ec.DBotScore = {Indicator: args.hash, Type: 'hash', Vendor: 'OPSWAT', Score: dbotScore};


            return {Type: entryTypes.note, Contents: res, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
        } else {
            md += 'No results for this hash\n';

            return {Type: entryTypes.note, Contents: res, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
        }
    };


    var scanFile = function() {
        var res;
        var fileName = dq(invContext, 'File(val.EntryID == \'' + args.fileId + '\').Name');

        if (!fileName) {
            throw 'Wrong FileID\n';
        }

        try {
            res = JSON.parse(sendRequest('file', '' , args.fileId).Body);
        } catch (err) {
            throw 'Error in JSON parsing\n';
        }
        var md = '# OPSWAT-Metadefender\n';
        var ec = {};

        md += 'The file has been successfully submitted to scan.\n';
        md += 'Scan id: ' + res.data_id + '\n';

        ec.OPSWAT = {
            FileName: fileName[0],
            ScanId: res.data_id
        };

        return {Type: entryTypes.note, Contents: res, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
    };


    var getScanResult = function() {
        var res;
        try {
            res = JSON.parse(sendRequest('file/' + args.id, '').Body);
        } catch (err) {
            throw 'Error in JSON parsing\n';
        }

        var md = '# OPSWAT-Metadefender\n';
        var ec = {};
        var dbotScore = 0;

        md += '### Results for scan id ' + args.id + '\n';

        if (res.file_info &&
            res.process_info) {
            if (res.process_info.progress_percentage < 100) {
                md += '### The scan proccess is in progrees (done: ' + res.process_info.progress_percentage + '%) \n'
            }
            md += 'File name: ' + res.file_info.display_name + '\n';
            md += 'File description: ' + res.file_info.file_type_description + '\n';
            if (res.scan_results) {
                md += 'Scan result: ' + res.scan_results.scan_all_result_a + '\n';
                md += 'Detected AV: ' + res.scan_results.scan_all_result_i + '/' + res.scan_results.total_avs + '\n';
            }

            md += 'Scan progress percentage ' + res.process_info.progress_percentage + '\n';

            var percntBad = (res.scan_results.scan_all_result_i / res.scan_results.total_avs) * 100;

            ec['OPSWAT(val.ScanId == ' + args.id + ').ScanProgress'] = res.process_info.progress_percentage;
            ec['OPSWAT(val.ScanId == ' + args.id + ').PercentageBad'] = percntBad;
            ec['OPSWAT(val.ScanId == ' + args.id + ').Result'] = res.scan_results.scan_all_result_a;


            md += 'AV Name|Def Time|Threat Name Found\n';
            md += '---|---|---\n';

            var avRes = res.scan_results.scan_details;

            Object.keys(avRes).forEach(function(key) {
              md += key + '|';
              md += avRes[key].def_time + '|';
              md += avRes[key].threat_found + '\n';
            });



            if (percntBad >= parseInt(params.highPercnt)) {
                dbotScore = 3;
                addMalicious(ec, outputPaths.file,{
                    Hash: res.file_info.md5,
                    Malicious: {Vendor: 'OPSWAT', Description: 'Result from OPSWAT-Metadefender'}
                });
            } else if (percntBad >= parseInt(params.lowPercnt)) {
                dbotScore = 2;
            } else {
                dbotScore = 1;
            }
            ec.DBotScore = {Indicator: res.file_info.md5, Type: 'hash', Vendor: 'OPSWAT', Score: dbotScore};


            return {Type: entryTypes.note, Contents: res, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
        } else {
            md += 'No results for this id\n';

            return {Type: entryTypes.note, Contents: res, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
        }
    };


    switch (command) {
        // This is the call made when pressing the integration test button.
        case 'test-module':
            var res = sendRequest('/hash/', 'BED12FDA073BB386B54700138FB47EEA');
            return 'ok';
        case 'opswat-hash':
            return searchHash();
        case 'opswat-scan-file':
            return scanFile();
        case 'opswat-scan-result':
            return getScanResult();
        default:
            throw 'Unknown command - ' + command;
    }
  type: javascript
  commands:
  - name: opswat-hash
    arguments:
    - name: hash
      required: true
      default: true
      description: File hash (Can be any hash type)
    description: Check file hash on OPSWAT
  - name: opswat-scan-file
    arguments:
    - name: fileId
      required: true
      default: true
      description: Entry id of a file in Demisto
    outputs:
    - contextPath: OPSWAT.FileName
      description: OPSWAT file name to scan
    - contextPath: OPSWAT.ScanId
      description: OPSWAT scan id of the scan
    description: Scan file in OPSWAT
  - name: opswat-scan-result
    arguments:
    - name: id
      required: true
      default: true
      description: OPSWAT scan id
    description: Get OPSWAT result
